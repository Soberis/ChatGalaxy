# Code Quality & Coverage Pipeline
# 2025å¹´æ ‡å‡†çš„ä»£ç è´¨é‡æ£€æŸ¥å’Œè¦†ç›–ç‡æŠ¥å‘Šå·¥ä½œæµ

name: Code Quality & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œè´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20.19.0'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '9'

jobs:
  # å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥
  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºSonarCloudåˆ†æ
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: './frontend/pnpm-lock.yaml'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ESLintæ£€æŸ¥
      run: |
        pnpm run lint --format=json --output-file=eslint-report.json || true
        pnpm run lint
        
    - name: Prettieræ ¼å¼æ£€æŸ¥
      run: pnpm run format:check
      
    - name: TypeScriptç±»å‹æ£€æŸ¥
      run: pnpm run type-check
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
      run: |
        pnpm run test:unit --coverage --reporter=json --reporter=lcov
        
    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./frontend/coverage
        flags: frontend
        name: frontend-coverage
        fail_ci_if_error: false
        
    - name: SonarCloudä»£ç åˆ†æ
      uses: SonarSource/sonarcloud-github-action@master
      if: github.event_name != 'schedule'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: ./frontend
        args: >
          -Dsonar.projectKey=chatgalaxy-frontend
          -Dsonar.organization=chatgalaxy
          -Dsonar.sources=src
          -Dsonar.tests=src
          -Dsonar.test.inclusions=**/*.test.ts,**/*.spec.ts
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
          -Dsonar.eslint.reportPaths=eslint-report.json
          
    - name: Bundleåˆ†æ
      run: |
        pnpm run build
        npx vite-bundle-analyzer dist --json > bundle-analysis.json
        
    - name: æ€§èƒ½é¢„ç®—æ£€æŸ¥
      run: |
        # æ£€æŸ¥bundleå¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶
        BUNDLE_SIZE=$(du -sb dist | cut -f1)
        MAX_SIZE=5242880  # 5MB
        if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
          echo "âŒ Bundle size ($BUNDLE_SIZE bytes) exceeds limit ($MAX_SIZE bytes)"
          exit 1
        else
          echo "âœ… Bundle size ($BUNDLE_SIZE bytes) within limit"
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: frontend-quality-reports
        path: |
          frontend/coverage/
          frontend/eslint-report.json
          frontend/bundle-analysis.json
          frontend/dist/
          
  # åç«¯ä»£ç è´¨é‡æ£€æŸ¥
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: './backend/requirements.txt'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage pytest-cov pytest-html
        
    - name: Ruffä»£ç æ£€æŸ¥
      run: |
        pip install ruff
        ruff check . --format=json --output-file=ruff-report.json || true
        ruff check .
        
    - name: Ruffä»£ç æ ¼å¼æ£€æŸ¥
      run: ruff format --check .
      
    - name: MyPyç±»å‹æ£€æŸ¥
      run: |
        pip install mypy
        mypy app --json-report mypy-report
        
    - name: Banditå®‰å…¨æ‰«æ
      run: |
        pip install bandit[toml]
        bandit -r app -f json -o bandit-report.json || true
        bandit -r app
        
    - name: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
      run: |
        coverage run -m pytest tests/ -v --html=pytest-report.html --self-contained-html
        coverage xml
        coverage html
        coverage report
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        ENVIRONMENT: test
        
    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./backend
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false
        
    - name: SonarCloudä»£ç åˆ†æ
      uses: SonarSource/sonarcloud-github-action@master
      if: github.event_name != 'schedule'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: ./backend
        args: >
          -Dsonar.projectKey=chatgalaxy-backend
          -Dsonar.organization=chatgalaxy
          -Dsonar.sources=app
          -Dsonar.tests=tests
          -Dsonar.python.coverage.reportPaths=coverage.xml
          -Dsonar.python.bandit.reportPaths=bandit-report.json
          
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: backend-quality-reports
        path: |
          backend/htmlcov/
          backend/coverage.xml
          backend/pytest-report.html
          backend/ruff-report.json
          backend/bandit-report.json
          backend/mypy-report/
          
  # ä»£ç è´¨é‡é—¨ç¦
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [frontend-quality, backend-quality]
    if: always()
    
    steps:
    - name: ä¸‹è½½è´¨é‡æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        path: ./reports
        
    - name: è´¨é‡é—¨ç¦æ£€æŸ¥
      run: |
        echo "## ğŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å‰ç«¯è´¨é‡
        if [ "${{ needs.frontend-quality.result }}" = "success" ]; then
          echo "âœ… Frontend Quality: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Frontend Quality: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥åç«¯è´¨é‡
        if [ "${{ needs.backend-quality.result }}" = "success" ]; then
          echo "âœ… Backend Quality: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Backend Quality: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ Coverage Reports" >> $GITHUB_STEP_SUMMARY
        echo "- [Frontend Coverage](https://codecov.io/gh/${{ github.repository }}/tree/${{ github.sha }}/frontend)" >> $GITHUB_STEP_SUMMARY
        echo "- [Backend Coverage](https://codecov.io/gh/${{ github.repository }}/tree/${{ github.sha }}/backend)" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æœä»»ä¸€æ£€æŸ¥å¤±è´¥ï¼Œæ•´ä¸ªå·¥ä½œæµå¤±è´¥
        if [ "${{ needs.frontend-quality.result }}" != "success" ] || [ "${{ needs.backend-quality.result }}" != "success" ]; then
          echo "âŒ Quality gate failed. Please fix the issues before merging."
          exit 1
        fi
        
        echo "âœ… All quality checks passed!"
        
    - name: PRè¯„è®ºè´¨é‡æŠ¥å‘Š
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const frontendStatus = '${{ needs.frontend-quality.result }}';
          const backendStatus = '${{ needs.backend-quality.result }}';
          
          let comment = '## ğŸ“Š Code Quality Report\n\n';
          comment += `| Component | Status | Result |\n`;
          comment += `|-----------|--------|--------|\n`;
          comment += `| Frontend | ${frontendStatus === 'success' ? 'âœ…' : 'âŒ'} | ${frontendStatus} |\n`;
          comment += `| Backend | ${backendStatus === 'success' ? 'âœ…' : 'âŒ'} | ${backendStatus} |\n\n`;
          
          comment += '### ğŸ“ˆ Coverage Reports\n';
          comment += `- [Frontend Coverage](https://codecov.io/gh/${context.repo.owner}/${context.repo.repo}/tree/${context.sha}/frontend)\n`;
          comment += `- [Backend Coverage](https://codecov.io/gh/${context.repo.owner}/${context.repo.repo}/tree/${context.sha}/backend)\n\n`;
          
          if (frontendStatus === 'success' && backendStatus === 'success') {
            comment += 'ğŸ‰ **All quality checks passed! Ready for review.**';
          } else {
            comment += 'âš ï¸ **Quality checks failed. Please fix the issues before merging.**';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });